<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FakeAuth Callback</title>
</head>
<body>
  <script>
  function parseParams() {
    // 1. Coba dari hash dulu (#id_token=...)
    let hash = window.location.hash;
    if (hash && hash.startsWith("#")) {
      hash = hash.substring(1);
      const params = new URLSearchParams(hash);
      const idToken = params.get("id_token");
      const state = params.get("state");
      if (idToken) {
        return { idToken, state };
      }
    }

    // 2. Kalau di hash tidak ada, coba dari query (?id_token=...)
    const search = window.location.search;
    if (search && search.startsWith("?")) {
      const params = new URLSearchParams(search.substring(1));
      return {
        idToken: params.get("id_token"),
        state: params.get("state")
      };
    }

    return { idToken: null, state: null };
  }

  function decodeIdToken(idToken) {
    try {
      const json = atob(idToken);
      return JSON.parse(json);
    } catch (e) {
      return null;
    }
  }

  (function () {
    const { idToken, state } = parseParams();
    if (!window.opener) {
      document.body.innerText = "No opener window. This callback is intended to be opened via popup.";
      return;
    }

    if (!idToken) {
      window.opener.postMessage({
        type: "FAKEAUTH_RESULT",
        error: "id_token tidak ditemukan"
      }, "https://fake-auth-seven.vercel.app");
      return;
    }

    const payload = decodeIdToken(idToken);
    if (!payload) {
      window.opener.postMessage({
        type: "FAKEAUTH_RESULT",
        error: "id_token invalid"
      }, "https://fake-auth-seven.vercel.app");
      return;
    }

    window.opener.postMessage({
      type: "FAKEAUTH_RESULT",
      idToken: idToken,
      state: state,
      user: {
        sub: payload.sub,
        name: payload.name
      }
    }, "https://fake-auth-seven.vercel.app");
  })();
</script>

</body>
</html>
