<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FakeAuth Provider - Multi Account Login</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: #f3f4f6;
      margin: 0;
    }
    .card {
      background: white;
      padding: 24px;
      border-radius: 16px;
      box-shadow: 0 18px 40px rgba(15,23,42,0.18);
      width: 360px;
    }
    h1 {
      margin: 0 0 8px 0;
      font-size: 20px;
    }
    .subtitle {
      margin: 0 0 16px 0;
      font-size: 13px;
      color: #6b7280;
    }
    .section-title {
      font-size: 13px;
      margin: 12px 0 8px;
      color: #4b5563;
      font-weight: 600;
    }
    .accounts {
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      overflow: hidden;
      background: #f9fafb;
    }
    .account-btn {
      display: flex;
      align-items: center;
      gap: 10px;
      width: 100%;
      padding: 10px 12px;
      border: none;
      background: transparent;
      cursor: pointer;
      text-align: left;
    }
    .account-btn + .account-btn {
      border-top: 1px solid #e5e7eb;
    }
    .account-btn:hover {
      background: #e5e7eb;
    }
    .avatar {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: #111827;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 14px;
      flex-shrink: 0;
    }
    .acc-main {
      flex: 1;
    }
    .acc-name {
      font-size: 14px;
      color: #111827;
    }
    .acc-sub {
      font-size: 12px;
      color: #6b7280;
    }
    .remove-btn {
      border: none;
      background: transparent;
      color: #9ca3af;
      cursor: pointer;
      font-size: 14px;
      padding: 4px;
    }
    .remove-btn:hover {
      color: #ef4444;
    }
    .or {
      text-align: center;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .06em;
      color: #9ca3af;
      margin: 14px 0 10px;
      position: relative;
    }
    .or::before,
    .or::after {
      content: "";
      position: absolute;
      top: 50%;
      width: 32%;
      height: 1px;
      background: #e5e7eb;
    }
    .or::before { left: 0; }
    .or::after { right: 0; }
    label {
      font-size: 13px;
      display: block;
      margin-bottom: 4px;
      color: #4b5563;
    }
    input {
      width: 100%;
      padding: 8px 10px;
      margin-bottom: 10px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      box-sizing: border-box;
    }
    button.primary {
      width: 100%;
      padding: 10px;
      border-radius: 999px;
      border: none;
      background: #2563eb;
      color: white;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
      margin-top: 4px;
    }
    button.primary:hover {
      background: #1d4ed8;
    }
    .link-btn {
      margin-top: 8px;
      border: none;
      background: transparent;
      color: #2563eb;
      font-size: 13px;
      cursor: pointer;
      padding: 0;
    }
    .small {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 8px;
    }
    .hidden {
      display: none;
    }
    .error {
      color: #b91c1c;
      font-size: 12px;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>FakeAuth</h1>
    <p class="subtitle">Multi-account login ala Google (dipakai oleh iOS SDK dan Web SDK).</p>

    <div id="choose-section">
      <div class="section-title">Choose an account</div>
      <div id="accounts-container" class="accounts"></div>
      <button id="use-another-btn" class="link-btn" type="button">Use another account</button>
      <button id="clear-all-btn" class="link-btn" type="button" style="color:#b91c1c;">Remove all accounts</button>
    </div>

    <div id="or-divider" class="or">OR</div>

    <form id="login-form">
      <div class="section-title">Sign in</div>
      <label for="username">Username</label>
      <input id="username" name="username" autocomplete="username" />

      <label for="password">Password</label>
      <input id="password" name="password" type="password" autocomplete="current-password" />

      <button type="submit" class="primary">Continue</button>
      <div id="error" class="error"></div>
      <div class="small">
        Setelah login / pilih account, kami akan redirect ke
        <code>redirect_uri</code> dengan <code>id_token</code> di URL hash.
      </div>
    </form>
  </div>

  <script>
    const ACCOUNTS_KEY = "fakeauth_accounts";

    function getQueryParams() {
      const params = new URLSearchParams(window.location.search);
      return {
        redirectUri: params.get("redirect_uri"),
        state: params.get("state") || ""
      };
    }

    function loadAccounts() {
      try {
        const raw = localStorage.getItem(ACCOUNTS_KEY);
        if (!raw) return [];
        const list = JSON.parse(raw);
        if (!Array.isArray(list)) return [];
        return list;
      } catch {
        return [];
      }
    }

    function saveAccounts(list) {
      localStorage.setItem(ACCOUNTS_KEY, JSON.stringify(list));
    }

    function upsertAccount(username) {
      const list = loadAccounts();
      const normalized = username.trim();
      const existing = list.find(a => a.username === normalized);
      const now = Date.now();
      if (existing) {
        existing.lastUsedAt = now;
      } else {
        list.push({
          id: normalized,        // di real world ini biasanya id unik
          username: normalized,
          lastUsedAt: now
        });
      }
      saveAccounts(list);
    }

    function removeAccount(username) {
      let list = loadAccounts();
      list = list.filter(a => a.username !== username);
      saveAccounts(list);
    }

    function clearAllAccounts() {
      localStorage.removeItem(ACCOUNTS_KEY);
    }

    function createFakeIdToken(username) {
      const payload = {
        sub: username,
        name: username,
        iat: Math.floor(Date.now() / 1000),
        iss: window.location.origin
      };
      return btoa(JSON.stringify(payload)); // base64 JSON, bukan JWT beneran
    }

    function completeLogin(username) {
      const { redirectUri, state } = getQueryParams();
      const errorEl = document.getElementById("error");

  console.log("completeLogin redirectUri =", redirectUri);
  console.log("completeLogin state =", state);
  
      if (!redirectUri) {
        errorEl.textContent = "redirect_uri tidak ada. Harus dikirim oleh client (iOS/Web).";
        return;
      }
      if (!username) {
        errorEl.textContent = "Username wajib diisi.";
        return;
      }

      const idToken = createFakeIdToken(username.trim());

      const redirectUrl =
        redirectUri +
        "?id_token=" + encodeURIComponent(idToken) +
        "&state=" + encodeURIComponent(state || "");

      // â¬‡ï¸ Ini yang akan ditangkap oleh:
      // - Web (via callback.html + postMessage)
      // - iOS (via ASWebAuthenticationSession)
      window.location.href = redirectUrl;
    }

    function renderAccounts() {
      const accounts = loadAccounts().sort((a, b) => (b.lastUsedAt || 0) - (a.lastUsedAt || 0));
      const container = document.getElementById("accounts-container");
      const chooseSection = document.getElementById("choose-section");
      const orDivider = document.getElementById("or-divider");

      container.innerHTML = "";

      if (accounts.length === 0) {
        chooseSection.classList.add("hidden");
        orDivider.classList.add("hidden");
        return;
      }

      chooseSection.classList.remove("hidden");
      orDivider.classList.remove("hidden");

      accounts.forEach(acc => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "account-btn";
        btn.dataset.username = acc.username;

        const avatar = document.createElement("div");
        avatar.className = "avatar";
        avatar.textContent = (acc.username[0] || "?").toUpperCase();

        const main = document.createElement("div");
        main.className = "acc-main";

        const name = document.createElement("div");
        name.className = "acc-name";
        name.textContent = acc.username;

        const sub = document.createElement("div");
        sub.className = "acc-sub";
        sub.textContent = acc.username + "@example.com";

        main.appendChild(name);
        main.appendChild(sub);

        const remove = document.createElement("button");
        remove.type = "button";
        remove.className = "remove-btn";
        remove.textContent = "âœ•";
        remove.title = "Remove this account";
        remove.dataset.removeUsername = acc.username;

        btn.appendChild(avatar);
        btn.appendChild(main);
        btn.appendChild(remove);
        container.appendChild(btn);
      });
    }

    document.addEventListener("DOMContentLoaded", function () {
      const loginForm = document.getElementById("login-form");
      const errorEl = document.getElementById("error");
      const useAnotherBtn = document.getElementById("use-another-btn");
      const clearAllBtn = document.getElementById("clear-all-btn");
      const accountsContainer = document.getElementById("accounts-container");

      renderAccounts();

      // submit form (new login)
      loginForm.addEventListener("submit", function (e) {
        e.preventDefault();
        errorEl.textContent = "";

        const username = document.getElementById("username").value.trim();
        if (!username) {
          errorEl.textContent = "Username wajib diisi.";
          return;
        }

        upsertAccount(username);
        completeLogin(username); // ðŸ”¥ langsung callback ke redirect_uri
      });

      useAnotherBtn.addEventListener("click", function () {
        document.getElementById("username").focus();
      });

      clearAllBtn.addEventListener("click", function () {
        clearAllAccounts();
        renderAccounts();
      });

      // klik account di list
      accountsContainer.addEventListener("click", function (e) {
        const removeUsername = e.target.dataset.removeUsername;
        if (removeUsername) {
          e.stopPropagation();
          removeAccount(removeUsername);
          renderAccounts();
          return;
        }

        let btn = e.target;
        while (btn && !btn.classList.contains("account-btn")) {
          btn = btn.parentElement;
        }
        if (!btn) return;

        const username = btn.dataset.username;
        if (username) {
          upsertAccount(username); // update lastUsedAt
          completeLogin(username); // ðŸ”¥ langsung callback ke SDK (redirect_uri)
        }
      });
    });
  </script>
</body>
</html>
